{% extends 'users/base.html' %}
{% load static %}
{% block content %}

    <link rel="stylesheet" type="text/css" href="{% static 'input_page.css' %}">

    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-success fade in text-center" role="alert">
                <strong>{{ message }}</strong>
            </div>
        {% endfor %}
    {% endif %}

    <div class="donor-info-form mb-5">
        <form method="post" onsubmit="return submit_form()">
            {% csrf_token %}
            <h1 class="text-center mb-5">Input Page</h1>
            <hr>


            <!-- Begin Grid -->
            <div class="container shadow m-3" id="form-wrapper">
                <div class="row p-3">

                    <div class="col m-2 foreground-item">
                        <h3 class="d-flex justify-content-center">Donor Information</h3>
                        <hr>

                        <div class="row p-3 align-items-center">

                            <div class="col text-center align-top">
                                <label for="toggleAutocomplete">
                                    Autocomplete
                                    <input type="checkbox" name="toggleAutocomplete" id="toggleAutocomplete">
                                </label>
                            </div>

                            <div class="col text-center align-bottom">
                                <label for="anonymous" class="anonymous">
                                    Anonymous Donor
                                    <input type="checkbox" id="anonymous" name="anonymous" class="anonymous" onclick="anonymousToggle()">
                                </label>
                            </div>


                        </div>

                        <div class="mb-4" id="donor_form">

                            <div class="row p-2">
                                <div class="col">
                                    <span>
                                        <b>{{ donor_form.first_name.label }}</b>
                                        <div id='donor_form_first_name'>
                                            {{ donor_form.first_name }}
                                        </div>
                                    </span>
                                </div>
                                <div class="col">
                                    <span>
                                        <b>{{ donor_form.last_name.label }}</b>
                                        {{ donor_form.last_name }}
                                    </span>
                                </div>
                            </div>

                            <div class="row p-2">
                                <div class="col">
                                    <span>
                                        <b>{{ donor_form.email.label }}</b>
                                        {{ donor_form.email }}
                                    </span>
                                </div>
                                <div class="col">
                                    <span>
                                        <b>{{ donor_form.phone_number.label }}</b>
                                        {{ donor_form.phone_number }}
                                    </span>
                                </div>
                            </div>

                            <div class="row p-2">
                                <div class="col">
                                    <span>
                                        <b>{{ donor_form.address1.label }}</b>
                                        {{ donor_form.address1 }}
                                    </span>
                                </div>
                                <div class="col">
                                    <span>
                                        <b>{{ donor_form.address2.label }}</b>
                                        {{ donor_form.address2 }}
                                    </span>
                                </div>
                            </div>

                            <div class="row p-2">
                                <div class="col">
                                    <span>
                                        <b>{{ donor_form.city.label }}</b>
                                        {{ donor_form.city }}
                                    </span>
                                </div>
                                <div class="col">
                                    <span>
                                        <b>{{ donor_form.state.label }}</b>
                                        <select name="state" id="id_state" class="form-control">
                                            <option value="" disabled selected>State</option>
                                            {% for state,abr in states.items %}
                                            <option value="{{ abr }}">{{ state.title }}</option>
                                            {% endfor %}
                                        </select>
        {#                                {{ donor_form.state }}#}
                                    </span>
                                </div>

                                <div class="col">
                                    <span class="mb-4">
                                        <b>{{ donor_form.zip.label }}</b>
                                        {{ donor_form.zip }}
                                    </span>
                                </div>
                            </div>

                        </div>
                    </div> <!-- End Donor Information column -->

                    <div class="col m-2 foreground-item">

                        <div id="donation_form">

                            <div>
                                <h3 class="text-center"> Donation Information</h3>
                                <hr>
                            </div>

                            <div class="row p-3 align-items-center">


                                <div class="col-3">
                                    <span>
                                        <b>{{ donation_info_form.thanks_sent.label }}</b>
                                        {{ donation_info_form.thanks_sent }}
                                    </span>
                                </div>

                                <div class="col-4 m-2">
                                    <span>
                                        <b>{{ donation_info_form.date_received.label }}</b>
                                        {{ donation_info_form.date_received }}
                                    </span>
                                </div>
                            </div>


                            <div class="row p-3">
                                <div class="col m-2">
                                    <span>
                                        <b>{{ donation_info_form.comment.label }}</b>
                                            {{ donation_info_form.comment }}
                                    </span>
                                </div>
                            </div>
                        </div>

                    </div> <!-- End Donation Information column -->

                </div> <!-- End First Row -->

                <div class="row p-3">
                    <div class="col m-2 foreground-item">
                        <div id="items_form">

                            <h3 class="d-flex justify-content-center">Items</h3>
                            <hr>

                            <div class="d-flex justify-content-end">

                                <button id="remove_button" type="button" class="btn btn-default btn-sm">
                                    <span class="glyphicon glyphicon-trash" aria-hidden="true"></span>
                                </button>

                                <button id="add_button" type="button" class="btn btn-default btn-sm">
                                    <span class="glyphicon glyphicon-plus" aria-hidden="true"></span>
                                </button>

                            </div>

                            <br>

                            <table class="table shadow p-3 mb-5 bg-body rounded">
                                <thead>
                                    <tr>
                                        <th class="col-1">#</th>
                                        <th class="col-3">Type</th>
                                        <th class="col-2">Qty.</th>
                                        <th class="col-3">Sub Type</th>
                                        <th class="col-3">Amount</th>
                                    </tr>
                                </thead>

                                <tbody id="items_body">
                                    {{ item_formset.management_form }}
                                    {% for item_form in item_formset %}
                                        <tr class="shadow p-3 mb-5 bg-body rounded">
                                            <td>{{ item_form.type }}</td>
                                            <td>{{ item_form.quantity }}</td>
                                            <td>{{ item_form.sub_type_business }}</td>
                                        </tr>'
                                    {% endfor %}

                                </tbody>
                            </table>

                        </div>
                    </div>
                    <div class="col m-2 foreground-item">

                        <div id="funds_form">

                            <h3 class="d-flex justify-content-center">Funds</h3>
                            <hr>

                            <span>
                                <div class=" mb-5">
                                    <b>{{ funds_form.type.label }}</b>
                                    {{ funds_form.type }}
                                </div>

                            </span>
                            <span>
                                <div>
                                    <b>{{ funds_form.amount.label }}</b>
                                       {{ funds_form.amount }}
                                </div>
                            </span>

                        </div>

                    </div> <!-- End Funds Column -->

                </div> <!-- End Second Row -->

                <div class="row p-3">

                    <div class="col m-2 foreground-item">
                        <div>
                            <button class="btn btn-primary btn-lg center-block mt-3 mb-3 w-22 btn-danger border border-dark shadow" id="clear_fields">
                                Clear
                            </button>
                        </div>
                    </div>

                    <div class="col m-2 foreground-item">
                        <div>
                            <button type="submit" class="btn btn-primary btn-lg center-block mt-3 mb-3 w-22 shadow read">Submit</button>
                        </div>
                    </div>

                </div> <!-- End Third Row -->

            </div> <!-- End Grid-->

        </form>
    </div>



<!-- XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX -->


    <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <style>
        #donor-label {
            display: block;
            font-weight: bold;
            margin-bottom: 1em;
        }

        #donor-description {
            margin: 0;
            padding: 0;
        }
    </style>
    <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <script type="text/javascript">


        function onAutocompleteItemSelect(event, ui) {
            $("#id_first_name").val(ui.item.first_name);
            $("#id_last_name").val(ui.item.last_name);
            $("#id_email").val(ui.item.email_address);
            $("#id_phone_number").val(ui.item.phone_number);
            $("#id_address1").val(ui.item.address_line1);
            $("#id_address2").val(ui.item.address_line2);
            $("#id_city").val(ui.item.city);
            $("#id_state").val(ui.item.state); // might not be that easy but let's find out :)
            $("#id_zip").val(ui.item.zipcode);
            // // debug
            // console.log(ui.item.first_name + " " + ui.item.email + " " + ui.item.phone_number + " " + ui.item.address1 + " " + ui.item.address2 + " " + ui.item.city + " " + ui.item.state + " " + ui.item.zipcode);
            return false;
        }

        function prettyPrintAutocompleteResults(autocompleteFunction) {
            autocompleteFunction.autocomplete("instance")._renderItem = function (ul, item) {
                // build the li option for the ul element
                // the donor always has at least a first name
                // the user won't be able to see " " + "" so we don't have to worry about the last name being blank
                var option = "<div><strong>" + item.first_name + " " + item.last_name + "</strong>";

                // add the email, phone, address lines (if they exist)
                if (!(item.email_address === "")) {
                    option = option + "<br>" + item.email_address;
                }
                if (!(item.phone_number === "")) {
                    option = option + "<br>" + item.phone_number;
                }
                if (!(item.address_line1 === "")) {
                    option = option + "<br>" + item.address_line1;
                }
                if (!(item.address_line2 === "")) {
                    option = option + "<br>" + item.address_line2;
                }

                // if the city, state, or zipcode exist, add them in "city, state, zipcode" format
                // any blank attributes here get filled with ?'s
                if (!(item.city === "" && item.state === "" && item.zipcode === "")) {
                    option = option + "<br>";
                    if (item.city === "") {
                        option = option + "?, ";
                    } else {
                        option = option + item.city + ", ";
                    }
                    if (item.state === "") {
                        option = option + "?, ";
                    } else {
                        option = option + item.state + ", ";
                    }
                    if (item.zipcode === "") {
                        option = option + "?";
                    } else {
                        option = option + item.zipcode;
                    }
                }
                option = option + "</div>";

                return $("<li>").append(option).appendTo(ul);
            };
        }

        $(function () {
            // autocomplete 'em
            prettyPrintAutocompleteResults($('#id_first_name').autocomplete({
                minLength: 2,
                source: "get_donors/?name_type=first",
                focus: function (event, ui) {
                    $("#id_first_name").val(ui.item.first_name);
                    return false;
                },
                select: onAutocompleteItemSelect,
                messages: {
                    noResults: function (_) {
                        console.log("There were no matches.")
                        {# Disable searching functionality once the user gets no results back #}
                        {# Autocomplete should be disabled if more than a threshold (5) consecutive empty results #}
                        {# TODO display a toggle button to pause the autocomplete functionality #}
                        {# Changes should effect both autocomplete fields #}
                        $('#id_first_name').autocomplete("disable");
                        {#$('#id_first_name').autocomplete("enable");#}
                    },
                    results: function (count) {
                        console.log("There were " + count + " matches")
                    }
                }
            }));

            prettyPrintAutocompleteResults($('#id_last_name').autocomplete({
                minLength: 2,
                source: "get_donors/?name_type=last",
                focus: function (event, ui) {
                    $("#id_last_name").val(ui.item.last_name);
                    return false;
                },
                select: onAutocompleteItemSelect
            }))
        });

        function anonymousToggle() {
            $("#donor_form").slideToggle(300);
        }

        function items_completed() {
            return document.querySelector("#items_form #id_type").selectedIndex !== -1 && document.querySelector("#items_form #id_quantity").value !== '' && document.getElementById("id_name").selectedIndex !== -1
        }

        function funds_completed() {
            return document.querySelector("#funds_form #id_type").selectedIndex !== -1 && document.querySelector("#funds_form #id_amount").value !== ''
        }

        function donation_information_completed() {
            return document.querySelector("#donation_form #id_amount").value !== '' && document.querySelector("#donation_form #id_date_received").value !== '';
        }


        function submit_form() {
            {#TODO rmove early return, only for current testing #}
            {#clean_inputs();#}
            return true;
            document.querySelectorAll("textarea").forEach(e => e.value = DOMPurify.sanitize(e.value));
            if ((items_completed() || funds_completed()) && document.getElementById("anonymous").checked === true) {
                return true;
            } else {
                {#TODO: Enhance error messages#}
                document.querySelector("#message").style.opacity = '1';
                document.querySelector("#message").innerHTML = "Please make sure to fill up required fields";
                return false;
            }
        }

        function items_row_clicked(e) {
            $(e).parent().children().removeClass("selected");
            $(e).addClass("selected");
        }

        let formset_total_forms = parseInt($("#id_form-TOTAL_FORMS")[0].value);

        {% spaceless %}
            let itemCount = 0;
            $("#add_button").click(function (e) {
                e.preventDefault();

                let typeId = "id_form-" + formset_total_forms + "-type"
                let quantityId = "id_form-" + formset_total_forms + "-quantity"
                let amountId = "id_form-" + formset_total_forms + "-amount"
                let subtypeId = "id_form-" + formset_total_forms + "-sub_type_business"

                let row_count = $('<td class="col">' + (formset_total_forms + 1).toString() + '</td>')
                let type = $('{{item_form.type}}').attr({id: typeId, name: typeId})
                let quantity = $('{{item_form.quantity}}').attr({id: quantityId, name: quantityId})
                let amount = $('{{item_form.amount}}').attr({id: amountId, name: amountId})
                let subType = $('{{item_form.sub_type_business}}').attr({id: subtypeId, name: subtypeId})

                let row = $('<tr class="shadow p-3 mb-5 bg-body rounded"></tr>')
                row.append(row_count)
                row.append("<td class='col-3'>" + type[0].outerHTML + "</td>")
                row.append("<td class='col-2'>" + quantity[0].outerHTML + "</td>")
                row.append("<td class='col-3'>" + subType[0].outerHTML + "</td>")
                row.append("<td class='col-3'>" + amount[0].outerHTML + "</td>")

                $("#items_body").append(row)

                formset_total_forms++

                row.click(function () {
                    {#Add event listener to new rows#}
                    items_row_clicked(row);
                });

                row.find("select:first").change(function (e) {
                    {#Add change listener to type field#}
                    changeSubTypeField(e, row)
                })
                $("#id_form-TOTAL_FORMS").attr("value", formset_total_forms)

            });
        {% endspaceless %}


        $("#remove_button").click(function (e) {
            if (formset_total_forms > 0) {

                formset_total_forms--;

                $("#id_form-TOTAL_FORMS").attr("value", formset_total_forms)
                let el = $("#items_body").children(".selected");

                if (el.length === 0) {
                    $("#items_body").children().last().remove()
                    return;
                }

                el.remove();

                $("#items_body").children("tr").each(function (rowIndex, row) {
                    $(row).children().each(function (inputIndex, input) {
                        if (inputIndex > 0) {
                            let inputField = $(input).children().first();

                            let id = inputField.attr("id").split("-")
                            id = id[0] + "-" + rowIndex + "-" + id[2]

                            let name = inputField.attr("name").split("-")
                            name = name[0] + "-" + rowIndex + "-" + name[2]

                            inputField.attr({id: id, name: name})
                        } else {
                            $(input).text(rowIndex + 1)
                        }
                    })
                })

            }
        });

        {#Add event listener to currnet tabel rows#}
        $("#items_body tr").click(function (e) {
            items_row_clicked($(this));
        });


        //let giftcard = '<select name="type" class="form-control" placeholder="Type" id="id_type"> <option value="Starbucks">Starbucks</option><option value="Target">Target</option><option value="Fandango">Fandango</option><option value="Walmart">Walmart</option><option value="Whole">Whole Foods</option><option value="Rei">Rei</option><option value="Netflix">Netflix</option><option value="Disney">Disney</option><option value="eBay">eBay</option><option value="American">American Express</option> <option value="Chick">Chick-Fil-A</option> <option value="McDonald">McDonald\'s</option> <option value="Google">Google Play</option> <option value="Best">Best Buy</option> <option value="iTunes">iTunes</option> <option value="Visa">Visa</option> <option value="Gamestop">Gamestop</option> <option value="Etsy">Etsy</option> <option value="Ikea">Ikea</option> <option value="Cracker">Cracker Barrel</option> <option value="Nordstrom">Nordstrom</option> <option value="Texas">Texas Roadhouse</option> <option value="Olive">Olive Garden</option> <option value="T">T.J. Maxx</option> <option value="Chipotle">Chipotle</option> <option value="Nike">Nike</option> <option value="Sephora">Sephora</option> <option value="Home">Home Depot</option> <option value="Amazon">Amazon</option> <option value="Costco">Costco</option> <option value="Old">Old Navy</option> <option value="American">American Airlines</option> <option value="Wawa">Wawa</option> <option value="Macy">Macy’s</option> <option value="Apple">Apple Store</option> <option value="Chili">Chili\'s Restaurant</option> <option value="Cabela">Cabela\'s</option> <option value="Ticketmaster">Ticketmaster</option> <option value="Michaels">Michaels</option> <option value="Kohl">Kohl\'s</option> <option value="Lowe">Lowe’s</option> <option value="Mastercard">Mastercard</option> <option value="Applebee">Applebee\'s</option> <option value="Red">Red Lobster</option> <option value="Subway">Subway</option> <option value="JCPenney">JCPenney</option> <option value="Dunkin">Dunkin Donuts</option> <option value="Burger">Burger King</option> <option value="Hobby">Hobby Lobbys</option> <option value="Taco">Taco Bell</option> <option value="Amazon">Amazon</option> <option value="Visa">Visa</option> <option value="Walmart">Walmart</option> <option value="Target">Target</option> <option value="Starbucks">Starbucks</option> <option value="eBay">eBay</option> <option value="American">American Express</option> <option value="iTunes">iTunes</option> <option value="Google">Google Play</option> <option value="Disney">Disney</option> <option value="Sephora">Sephora</option> <option value="Netflix">Netflix</option> <option value="Home">Home Depot</option> <option value="Chick">Chick-Fil-A</option> <option value="Best">Best Buy</option> <option value="McDonald">McDonald\'s</option> <option value="Gamestop">Gamestop</option> <option value="Dunkin">Dunkin Donuts</option> <option value="MasterCard">MasterCard</option> <option value="Fandango">Fandango</option> <option value="Etsy">Etsy</option> <option value="Rei">Rei</option> <option value="Macy">Macy’s</option> <option value="Olive">Olive Garden</option> <option value="Texas">Texas Roadhouse</option> <option value="Taco">Taco Bell</option> <option value="Chipotle">Chipotle</option> <option value="Nordstrom">Nordstrom</option> <option value="Ikea">Ikea</option> <option value="Subway">Subway</option> <option value="Lowe">Lowe’s</option> <option value="Kohl">Kohl\'s</option> <option value="Hobby">Hobby Lobbys</option> <option value="Nike">Nike</option> <option value="Ticketmaster">Ticketmaster</option> <option value="Whole">Whole Foods</option> <option value="Apple">Apple Store</option> <option value="Red">Red Lobster</option> <option value="Michaels">Michaels</option> <option value="T">T.J. Maxx</option> <option value="Costco">Costco</option> <option value="Cabela">Cabela\'s</option> <option value="Applebee">Applebee\'s</option> <option value="Chili">Chili\'s Restaurant</option> <option value="Burger">Burger King</option> <option value="Old">Old Navy</option> <option value="JCPenney">JCPenney</option> <option value="Cracker">Cracker Barrel</option> <option value="Wawa">Wawa</option> <option value="American">American Airlines</option> </select>';
        //let food = '<select name="type" class="form-control" placeholder="Type" id="id_type"><option>Food 1</option><option>Food 2</option><option>Food 3</option></select>'
        let clothing = ' {{item_form.sub_type_clothing|escapejs}} '
        let misc = '{{item_form.sub_type_name|escapejs}}'
        let food = '{{item_form.sub_type_name|escapejs}}'
        let giftcard = '{{item_form.sub_type_business|escapejs}}'

        //$("table tbody tr td select:last").replaceWith($(giftcard));

        function changeSubTypeField(e, row) {
            {#TODO: move that logic to a function to bind it to the new rows #}
            {#TODO: logic for replacing subtype#}
            let selected = e.target.value;
            let subTypeField = $($(row.children()[3]).children()[0])
            let amountField = $($(row.children()[4]).children()[0])
            //let subTypeField =  $(row.parents().eq(2).find("select:last, input:last")[1])

            let subTypeId = "id_form-" + (row[0].rowIndex - 1) + "-"


            if (selected === "giftcard") {
                subTypeId += "sub_type_business"
                subTypeField.replaceWith($(giftcard).attr({id: subTypeId, name: subTypeId}));
                amountField.show()
            } else {
                amountField.hide()
                if (selected === 'clothing') {
                    subTypeId += "sub_type_clothing"
                    subTypeField.replaceWith($(clothing).attr({id: subTypeId, name: subTypeId}));
                } else if (selected === 'food') {
                    subTypeId += "sub_type_name"
                    subTypeField.replaceWith($(food).attr({id: subTypeId, name: subTypeId}));
                } else if (selected === 'misc') {
                    subTypeId += "sub_type_name"
                    subTypeField.replaceWith($(misc).attr({id: subTypeId, name: subTypeId}));
                }
            }


            {#  $(this).parents().eq(2).find("select")[1] this is the subtype dropdown for the corresponding type #}
        }


        $("#clear_fields").click(function (e) {
            e.preventDefault();
            $(this).closest('form').find("input, textarea").val("");
            $("#id_state option:eq(0)").prop('selected', true);
        });

    </script>

    <script src="https://s3.amazonaws.com/novaksolutions/free/jquery.maskedinput.min.js"></script>
    <script>
        $("#id_phone_number").mask("(999) 999-9999?");

        /* Disable browser autocomplete, we can enable that only when the autocomplete functionality is enabled */
        $("input").focus(function () {
            $(this).attr("autocomplete", "new-password")
        });

        $('input').blur(function () {
            $(this).removeAttr('autocomplete');
        });
    </script>

{% endblock %}


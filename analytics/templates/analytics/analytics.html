{% extends 'users/base.html' %}

{% block content %}


    <form method="post" class="text-center">
        {% csrf_token %}

        {{ form }}

        <button type="submit" class="btn btn-primary btn-lg center-block mt-3 mb-5 w-25">Filter</button>
    </form>

    <h1 class="text-center">Analytics Main Page</h1>

    <div class="bd-example">

         <!-- Display all charts in dropdown accordion -->
        <div class="accordion" id="accordionExample">
            {% include "analytics/linechart.html" %}
            {% include "analytics/piechart.html" %}
            {% include "analytics/doughnut_chart.html" %}
        </div>

    </div>


    <!-- Display all charts in single column -->
    <h3>Number of Donations Per Month</h3>
    <div style="width:100%; height:55%;">
        <canvas id="bar-chart-2" width="350" height="100"></canvas>
    </div>

    <h3>Number of Donations Per Month W/ Quantity</h3>
    <div class = "m-5"style="width:100%; height:25%;">
        <canvas id="bar-chart-1" width="350" height="100"></canvas>
    </div>


    <h3>Donation Categories Pie Chart</h3>
    <div style="width:100%; height:100%;">
        <canvas id="pie-chart" width="500" height="500"></canvas>
    </div>

    <h3>Fund Categories Doughnut Chart</h3>
    <div style="width:100%; height:75%;">
        <canvas id="fund-doughnut-chart" width="300" height="150"></canvas>
    </div>




<script>

    let months = ['January', 'February', 'March', 'April', 'May', 'June', 'July','August','September','October','November','December'];

    $.ajax({
        url: 'get_donation_count_date_qty/',
        datatype: 'json',
        type: 'GET',
        success: function (response) {
            console.log('Donations W/ quantity (bar chart 1):', response);

            var ctx = document.getElementById('bar-chart-1').getContext('2d');
            var chart = new Chart(ctx, {

                type: 'bar',

                data: {
                    labels: months,
                    datasets: [{
                        label: 'Funds',
                        backgroundColor: "#3e95cd",
                        borderColor: "#3e95cd",
                        data: response["funds_table"]
                    },{
                        label: 'Gift Cards',
                        backgroundColor: "#8e5ea2",
                        borderColor: "#8e5ea2",
                        data: response["giftcards_table"]
                    },{
                        label: 'Clothing',
                        backgroundColor: "#3cba9f",
                        borderColor: "#3cba9f",
                        data: response["clothing_table"]
                    },{
                        label: 'Food',
                        backgroundColor: "#e8c3b9",
                        borderColor: "#e8c3b9",
                        data: response["foods_table"]
                    },{
                        label: 'Miscellaneous',
                        backgroundColor: "#c45850",
                        borderColor: "#c45850",
                        data: response["misc_table"]
                    }]
                },
                options: {}
            });

        }
    });



    $.ajax({
        url: 'get_donation_count_month/',
        datatype: 'json',
        type: 'GET',
        success: function (response) {

            console.log('Donations W/O quantity: (bar chart 2)', response);


            var ctx = document.getElementById('bar-chart-2').getContext('2d');
            var chart = new Chart(ctx, {

                type: 'bar',

                data: {
                    labels: months,
                    datasets: [{
                        label: 'Funds',
                        backgroundColor: "#3e95cd",
                        borderColor: "#3e95cd",
                        data: response["funds_table"]
                    },{
                        label: 'Gift Cards',
                        backgroundColor: "#8e5ea2",
                        borderColor: "#8e5ea2",
                        data: response["giftcards_table"]
                    },{
                        label: 'Clothing',
                        backgroundColor: "#3cba9f",
                        borderColor: "#3cba9f",
                        data: response["clothing_table"]
                    },{
                        label: 'Food',
                        backgroundColor: "#e8c3b9",
                        borderColor: "#e8c3b9",
                        data: response["foods_table"]
                    },{
                        label: 'Miscellaneous',
                        backgroundColor: "#c45850",
                        borderColor: "#c45850",
                        data: response["misc_table"]
                    }]
                },
                options: {}
            });
        }
    });



    $.ajax({
        url: 'get_donation_item_count/',
        datatype: 'json',
        type: 'GET',
        success: function (response) {
            console.log('Total donations by category (pie chart):', response);

            var ctx = document.getElementById('pie-chart').getContext('2d');
            var myChart = new Chart(ctx, {
            type: 'pie',
            data: {

                <!-- Donation Categories -->
                labels: ['Funds', 'Gift Cards', 'Clothing', 'Food', 'Miscellaneous'],
                datasets: [{
                    label: '# of Donations',

                    <!-- Donation Category Counts -->
                    data: [response["funds_table"], response["giftcards_table"], response["clothing_table"],response["foods_table"], response["misc_table"]],

                    backgroundColor: [
                        "#3e95cd",
                        "#8e5ea2",
                        "#3cba9f",
                        "#e8c3b9",
                        "#c45850",
                    ],
                    borderColor: [
                        "#3e95cd",
                        "#8e5ea2",
                        "#3cba9f",
                        "#e8c3b9",
                        "#c45850",
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,

                scales: {
                    yAxes: [{
                        ticks: {
                            beginAtZero: true
                        }
                    }]
                }
            }
        });

        }
    });


    Chart.pluginService.register({
      beforeDraw: function(chart) {
        if (chart.config.options.elements.center) {
          // Get ctx from string
          var ctx = chart.chart.ctx;

          // Get options from the center object in options
          var centerConfig = chart.config.options.elements.center;
          var fontStyle = centerConfig.fontStyle || 'Arial';
          var txt = centerConfig.text;
          var color = centerConfig.color || '#000';
          var maxFontSize = centerConfig.maxFontSize || 75;
          var sidePadding = centerConfig.sidePadding || 20;
          var sidePaddingCalculated = (sidePadding / 100) * (chart.innerRadius * 2)
          // Start with a base font of 30px
          ctx.font = "30px " + fontStyle;

          // Get the width of the string and also the width of the element minus 10 to give it 5px side padding
          var stringWidth = ctx.measureText(txt).width;
          var elementWidth = (chart.innerRadius * 2) - sidePaddingCalculated;

          // Find out how much the font can grow in width.
          var widthRatio = elementWidth / stringWidth;
          var newFontSize = Math.floor(30 * widthRatio);
          var elementHeight = (chart.innerRadius * 2);

          // Pick a new font size so it will not be larger than the height of label.
          var fontSizeToUse = Math.min(newFontSize, elementHeight, maxFontSize);
          var minFontSize = centerConfig.minFontSize;
          var lineHeight = centerConfig.lineHeight || 25;
          var wrapText = false;

          if (minFontSize === undefined) {
            minFontSize = 20;
          }

          if (minFontSize && fontSizeToUse < minFontSize) {
            fontSizeToUse = minFontSize;
            wrapText = true;
          }

          // Set font settings to draw it correctly.
          ctx.textAlign = 'center';
          ctx.textBaseline = 'middle';
          var centerX = ((chart.chartArea.left + chart.chartArea.right) / 2);
          var centerY = ((chart.chartArea.top + chart.chartArea.bottom) / 2);
          ctx.font = fontSizeToUse + "px " + fontStyle;
          ctx.fillStyle = color;

          if (!wrapText) {
            ctx.fillText(txt, centerX, centerY);
            return;
          }

          var words = txt.split(' ');
          var line = '';
          var lines = [];

          // Break words up into multiple lines if necessary
          for (var n = 0; n < words.length; n++) {
            var testLine = line + words[n] + ' ';
            var metrics = ctx.measureText(testLine);
            var testWidth = metrics.width;
            if (testWidth > elementWidth && n > 0) {
              lines.push(line);
              line = words[n] + ' ';
            } else {
              line = testLine;
            }
          }

          // Move the center up depending on line height and number of lines
          centerY -= (lines.length / 2) * lineHeight;

          for (var n = 0; n < lines.length; n++) {
            ctx.fillText(lines[n], centerX, centerY);
            centerY += lineHeight;
          }
          //Draw text in center
          ctx.fillText(line, centerX, centerY);
        }
      }
    });

    var ctx = document.getElementById('fund-doughnut-chart').getContext('2d');
    var myChart = new Chart(ctx, {
        type: 'doughnut',
        data: {

            <!-- Donation Categories -->
            labels: ['Cash', 'Electronic', 'Check'],
            datasets: [{
                label: '# of Fund Donations',

                <!-- Donation Category Counts -->
                data: [25, 10, 15],

                backgroundColor: [
                    'rgba(255, 99, 132, 0.2)',
                    'rgba(54, 162, 235, 0.2)',
                    'rgba(255, 206, 86, 0.2)',

                ],
                borderColor: [
                    'rgba(255, 99, 132, 1)',
                    'rgba(54, 162, 235, 1)',
                    'rgba(255, 206, 86, 1)',

                ],
                borderWidth: 1
            }]
        },
        options: {

            <!-- responsive: true, -->
            <!-- maintainAspectRatio: false, -->

            elements: {
                center: {
                    <!-- Adjust this to display actual total //-->
                    text: 'Total Fund Donations: 0',
                    color: '#FF6384', // Default is #000000
                    fontStyle: 'Arial', // Default is Arial
                    sidePadding: 20, // Default is 20 (as a percentage)
                    minFontSize: 25, // Default is 20 (in px), set to false and text will not wrap.
                    lineHeight: 25 // Default is 25 (in px), used for when text wraps
                }
            }
        }
    });




</script>


{% endblock %}


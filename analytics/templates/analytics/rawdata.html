{% extends 'users/base.html' %}

{% load static %}

{% block content %}


    <link rel="stylesheet" type="text/css" href="{% static 'raw_data.css' %}">

    <div class="shadow p-3 mb-5 rounded border foreground-item">

        <input type="button" value="Download" onclick="download_my_file()">

        <div id="search">
            <div class="row">
                <div class="col">
                    <label for="pagesize">Number of Rows:</label>
                    <select name="pagesize" id="pagesize" class="form-control">
                        <option value="5">5</option>
                        <option value="10" selected>10</option>
                        <option value="25">25</option>
                        <option value="50">50</option>
                    </select>
                </div>
            </div>
            <label for="id_first_name">First name:</label>
            <input type="text" name="first_name" maxlength="50" placeholder="First Name" id="id_first_name">
            <label for="id_last_name">Last name:</label>
            <input type="text" name="last_name" maxlength="50" placeholder="Last Name" id="id_last_name">
            <label for="id_donation_date_from">Donation date from:</label>
            <input type="date" name="donation_date_from" placeholder="YYYY-MM-DD" id="id_donation_date_from">
            <label for="id_donation_date_to">Donation date to:</label>
            <input type="date" name="donation_date_to" placeholder="YYYY-MM-DD" id="id_donation_date_to">

            <div class="row">
                <div class="col">
                    <button type="submit" class="btn btn-primary btn-lg center-block mt-3 mb-5 w-25 p-3 read"
                            onclick="submit_search_form()">Filter
                    </button>
                </div>
                <div class="col">
                    <button id="export" class="btn btn-primary btn-lg center-block mt-3 mb-5 w-25 p-3 read">Export
                    </button>
                </div>
            </div>


        </div>

        {#        <form method="get" class="text-center" onsubmit="">#}
        {#            {% csrf_token %}#}
        {#            {{ form }}#}
        {#            <div class="row">#}
        {#                <div class="col">#}
        {#                    <button type="submit" class="btn btn-primary btn-lg center-block mt-3 mb-5 w-25 p-3 read">Filter#}
        {#                    </button>#}
        {#                </div>#}
        {#                <div class="col">#}
        {#                    <button id="export" class="btn btn-primary btn-lg center-block mt-3 mb-5 w-25 p-3 read">Export#}
        {#                    </button>#}
        {#                </div>#}
        {##}
        {#            </div>#}
        {#        </form>#}
    </div>


    <fieldset>

        <legend class="mb-2">Show Donation Types:</legend>
        <div class="row">
            <div class="col">
                <label for="all">Select All:</label>
                <input class="donation_select m-3" type="checkbox" id="all" name="all" value="All" checked>
            </div>


            <div class="col">
                <label for="fund">Funds:</label>
                <input class="donation_select m-3" type="checkbox" id="fund" name="fund" value="Funds" checked>
            </div>

            <div class="col">
                <label for="gift">Gift Cards:</label>
                <input class="donation_select m-3" type="checkbox" id="gift" name="gift" value="Gift" checked>
            </div>

            <div class="col">
                <label for="clothing">Clothing:</label>
                <input class="donation_select m-3" type="checkbox" id="clothing" name="clothing" value="Clothing"
                       checked>
            </div>

            <div class="col">
                <label for="food">Food:</label>
                <input class="donation_select m-3" type="checkbox" id="food" name="food" value="Food" checked>
            </div>

            <div class="col">
                <label for="misc">Miscellaneous:</label>
                <input class="donation_select m-3" type="checkbox" id="misc" name="misc" value="Misc" checked>
            </div>
        </div>

    </fieldset>


    {# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #}
    <div id="content" class="content raw_data mt-5">


        <div class="donation_table p-3 m-5">
            <h2 class="text-center">Funds</h2>
            <hr>
            <table
                    {#                      data-query-params="queryParams"#}
                    id="funds_table" class="table table-striped table-bordered data-table"
                    data-sort-name="date_received" data-sort-order="desc"
                    data-custom-sort="datesSorter"
                    data-height="460"
                    data-search="true"
                    data-pagination="true"
                    data-advanced-search="true"
                    data-show-toggle="true"
                    data-show-columns="true"
                    data-show-export="false"
                    data-ajax="getTableData"
                    data-show-refresh="true"
                    data-page-list="[5,10, 25, 50]"
                    data-page-size="10"
                    data-side-pagination="server"
                    data-server-sort="false"
                    data-search-on-enter-key="true"
            >
                <thead class="fund_header">
                <tr>
                    <th data-sortable="true" data-field="item_id" data-filter-control="input">id</th>
                    <th data-sortable="true" data-field="first_name" data-filter-control="input">First Name</th>
                    <th data-sortable="true" data-field="last_name" data-filter-control="input">Last Name</th>
                    <th data-sortable="true" data-field="date_received" data-filter-control="input">Date Received</th>
                    <th data-sortable="true" data-field="sub_type" data-filter-control="select">Type</th>
                    <th data-sortable="true" data-field="amount" data-filter-control="input">Amount</th>
                    <th data-sortable="true" data-field="quantity" data-filter-control="input">Quantity</th>
                    <th data-sortable="true" data-field="comments" data-filter-control="input" class="text-capitalize">
                        Comments
                    </th>
                </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>


        <div class="donation_table p-3 m-5">
            <h2 class="text-center">Gift Cards</h2>
            <hr>
            <table
                    id="giftcards_table" class="table table-striped table-bordered data-table"
                    data-sort-name="date_received" data-sort-order="desc"
                    data-custom-sort="datesSorter"
                    data-height="460"
                    data-search="true"
                    data-pagination="true"
                    data-advanced-search="true"
                    data-show-toggle="true"
                    data-show-columns="true"
                    data-show-export="false"
                    data-ajax="getTableData"
                    data-show-refresh="true"
                    data-page-list="[5,10, 25, 50]"
                    data-page-size="10"
                    data-side-pagination="server"
                    data-server-sort="false"
                    data-search-on-enter-key="true"
            >
                <thead class="giftcard_header">
                <tr>
                    <th data-sortable="true" data-field="item_id" data-filter-control="input" data-visible="true">id
                    </th>
                    <th data-sortable="true" data-field="first_name" data-filter-control="input">First Name</th>
                    <th data-sortable="true" data-field="last_name" data-filter-control="input">Last Name</th>
                    <th data-sortable="true" data-field="date_received" data-filter-control="input">Date Received</th>
                    <th data-sortable="true" data-field="sub_type" data-filter-control="select">Type</th>
                    <th data-sortable="true" data-field="amount" data-filter-control="input">Amount</th>
                    <th data-sortable="true" data-field="quantity" data-filter-control="input">Quantity</th>
                    <th data-sortable="true" data-field="comments" data-filter-control="input" class="text-capitalize">
                        Comments
                    </th>
                </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>


        <div class="donation_table p-3 m-5">
            <h2 class="text-center">Food</h2>
            <hr>
            <table
                    id="foods_table" class="table table-striped table-bordered data-table"
                    data-sort-name="date_received" data-sort-order="desc"
                    data-custom-sort="datesSorter"
                    data-height="460"
                    data-search="true"
                    data-pagination="true"
                    data-advanced-search="true"
                    data-show-toggle="true"
                    data-show-columns="true"
                    data-show-export="false"
                    data-ajax="getTableData"
                    data-show-refresh="true"
                    data-page-list="[5,10, 25, 50]"
                    data-page-size="10"
                    data-side-pagination="server"
                    data-server-sort="false"
                    data-search-on-enter-key="true"
            >
                <thead class="food_header">
                <tr>
                    <th data-sortable="true" data-field="item_id" data-filter-control="input" data-visible="true">ID
                    </th>
                    <th data-sortable="true" data-field="first_name" data-filter-control="input"
                        class="text-capitalize">First Name
                    </th>
                    <th data-sortable="true" data-field="last_name" data-filter-control="input" class="text-capitalize">
                        Last Name
                    </th>
                    <th data-sortable="true" data-field="date_received" data-filter-control="input">Date Received</th>
                    <th data-sortable="true" data-field="sub_type" data-filter-control="select" class="text-capitalize">
                        Type
                    </th>
                    <th data-sortable="true" data-field="quantity" data-filter-control="input">Quantity</th>
                    <th data-sortable="true" data-field="comments" data-filter-control="input" class="text-capitalize">
                        Comments
                    </th>
                </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>


        <div class="donation_table p-3 m-5">
            <h2 class="text-center">Clothing</h2>
            <hr>
            <table
                    id="clothing_table" class="table table-striped table-bordered data-table"
                    data-sort-name="date_received" data-sort-order="desc"
                    data-custom-sort="datesSorter"
                    data-height="460"
                    data-search="true"
                    data-pagination="true"
                    data-advanced-search="true"
                    data-show-toggle="true"
                    data-show-columns="true"
                    data-show-export="false"
                    data-ajax="getTableData"
                    data-show-refresh="true"
                    data-page-list="[5,10, 25, 50]"
                    data-page-size="10"
                    data-side-pagination="server"
                    data-server-sort="false"
                    data-search-on-enter-key="true"
            >
                <thead class="clothing_header">
                <tr>
                    <th data-sortable="true" data-field="item_id" data-filter-control="input" data-visible="true">ID
                    </th>
                    <th data-sortable="true" data-field="first_name" data-filter-control="input"
                        class="text-capitalize">First Name
                    </th>
                    <th data-sortable="true" data-field="last_name" data-filter-control="input" class="text-capitalize">
                        Last Name
                    </th>
                    <th data-sortable="true" data-field="date_received" data-filter-control="input">Date Received</th>
                    <th data-sortable="true" data-field="sub_type" data-filter-control="select" class="text-capitalize">
                        Type
                    </th>
                    <th data-sortable="true" data-field="quantity" data-filter-control="input">Quantity</th>
                    <th data-sortable="true" data-field="comments" data-filter-control="input" class="text-capitalize">
                        Comments
                    </th>
                </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>


        <div class="donation_table m-5 p-3">
            <h2 class="text-center">Miscellaneous</h2>
            <hr>
            <table
                    id="misc_table" class="table table-striped table-bordered data-table"
                    data-sort-name="date_received" data-sort-order="desc"
                    data-custom-sort="datesSorter"
                    data-height="460"
                    data-search="true"
                    data-pagination="true"
                    data-advanced-search="true"
                    data-show-toggle="true"
                    data-show-columns="true"
                    data-show-export="false"
                    data-ajax="getTableData"
                    data-show-refresh="true"
                    data-page-list="[5,10, 25, 50]"
                    data-page-size="10"
                    data-side-pagination="server"
                    data-server-sort="false"
                    data-search-on-enter-key="true"
            >
                <thead class="misc_header">
                <tr>
                    <th data-sortable="true" data-field="item_id" data-filter-control="input" data-visible="true">ID
                    </th>
                    <th data-sortable="true" data-field="first_name" data-filter-control="input"
                        class="text-capitalize">First Name
                    </th>
                    <th data-sortable="true" data-field="last_name" data-filter-control="input" class="text-capitalize">
                        Last Name
                    </th>
                    <th data-sortable="true" data-field="date_received" data-filter-control="input">Date Received</th>
                    <th data-sortable="true" data-field="sub_type" data-filter-control="select" class="text-capitalize">
                        Type
                    </th>
                    <th data-sortable="true" data-field="quantity" data-filter-control="input">Quantity</th>
                    <th data-sortable="true" data-field="comments" data-filter-control="input" class="text-capitalize">
                        Comments
                    </th>
                </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>




    <script>
        function download_my_file() {
            window.location = "download_my_file"
        }

        {#function datesSorter0(sortName, sortOrder, data) {#}
        {#    let order = sortOrder === 'desc' ? -1 : 1#}
        {#    data.sort(datesSorter_, order)#}
        {# }#}

        function datesSorter(sortName, sortOrder, data) {
            let order = sortOrder === 'desc' ? -1 : 1
            data.sort(function (a, b) {
                {#console.log(sortName)#}
                let aa = a[sortName]
                let bb = b[sortName]
                return datesSorter_(aa, bb, order);
            })
        }

        var isDate = function (date) {
            {# FORMAT: 2021-04-08 #}
            return /^([12]\d{3}-(0[1-9]|1[0-2])-(0[1-9]|[12]\d|3[01]))/.test(date)
            {#return (new Date(date) != "Invalid Date") && !isNaN(new Date(date));#}
        }

        function isNumeric(str) {
            if (typeof str == "number") return true;
            else if (typeof str != "string") return false // we only process strings!
            return !isNaN(str) && // use type coercion to parse the _entirety_ of the string (`parseFloat` alone does not do this)...
                !isNaN(parseFloat(str)) // ...and ensure strings of whitespace fail
        }

        function datesSorter_(a, b, order) {
            if (isDate(a)) {
                {#console.log("DATE")#}
                if (new Date(a) < new Date(b)) return order * -1;
                if (new Date(a) > new Date(b)) return order;
                return 0;
            } else if (isNumeric(a)) {
                {#console.log("NUMBER")#}
                {#console.log(Math.sign(a - b))#}
                return Math.sign(a - b) * order;
            } else {
                if (a < b) return order * -1;
                if (a > b) return order;
                return 0;
            }
        }

        {#function queryParams(params) {#}
        {#    console.log("PARAMs: ")#}
        {#    console.log(params)#}
        {#    console.log($(this))#}
        {#    return params#}
        {# }#}

        function getClosure($this) {
            const exact = {
                "exact": {},
                "table_type": $this.attr("id"),
                "limit": $("#pagesize").val() - 0,
                "offset": 0,
                "order": undefined,
                "search": "",
                "sort": undefined
            }

            if ($("#id_first_name").val() !== "")
                exact["exact"]["first_name"] = $("#id_first_name").val()
            if ($("#id_last_name").val() !== "")
                exact["exact"]["last_name"] = $("#id_last_name").val()
            if ($("#id_donation_date_from").val() !== "")
                exact["exact"]["date_received_from"] = $("#id_donation_date_from").val()
            if ($("#id_donation_date_to").val() !== "")
                exact["exact"]["date_received_to"] = $("#id_donation_date_to").val()
            return exact;
        }

        function submit_search_form() {
            {# TODO add some checks data and strings/names #}
            {#console.log($("#id_donation_date_from").val() === "" && $("#id_donation_date_to").val() === "")#}
            {#if (#}
            {#    ($("#id_last_name").val() !== "" || $("#id_first_name").val() !== "") ||#}
            {#    ($("#donation_date_from").val() !== "" && $("#donation_date_to").val() !== "")#}
            {#) return 0;#}

            $('.data-table').each(function () {
                if ($(this).attr("id") !== undefined) {
                    const $thisTable = $(this)
                    const exact = getClosure($(this))
                    console.log(exact)
                    $.ajax({
                        url: 'get_table/',
                        datatype: 'json',
                        data: {"exact": JSON.stringify(exact)},
                        type: 'GET',
                        success: function (data) {
                            console.log(data)
                            console.log("OK")
                            console.log($(this))
                            $thisTable.bootstrapTable('load', {
                                "rows": data["rows"],
                                "total": data["total"]
                            })
                        },
                        error: function (er) {
                            console.log("ERROR!436")
                            params.error(er);
                            console.log("Error while pulling data with the following parameters:  " + er)
                        }
                    });
                } else {
                }
            })
        }


        function getTableData(params) {
            {#console.log("Params: ")#}
            {#console.log(params)#}
            let table_type = ""
            
            if ("exact" in params)
                table_type = params["table_type"]
            else
                table_type = $(this)[0].$el.attr("id")

            $.ajax({
                url: 'get_table/',
                datatype: 'json',
                data: $.param(params.data) + "&table_type=" + table_type,
                type: 'GET',
                success: function (data) {
                    {#console.log(data)#}
                    params.success({
                        "rows": data["rows"],
                        "total": data["total"]
                    })
                    return data;
                },
                error: function (er) {
                    params.error(er);
                    console.log("Error while pulling data with the following parameters:  " + er)
                }

            });
        }

        $(window).on('load', function () {
            $('.data-table').each(function () {
                $(this).bootstrapTable({});
            })
        });

    </script>




    {# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #}

    <script type="text/javascript">


        $(document).ready(function () {

            let tablesData = ['funds_table', 'giftcards_table', 'clothing_table', 'foods_table', 'misc_table']


            $('#fund').change(function () {
                if (this.checked === true) {
                    $('#funds_table').parents(".donation_table").slideDown(300);
                    tablesData.push('funds_table')
                } else {
                    $('#funds_table').parents(".donation_table").slideUp(300);
                    var index = tablesData.indexOf('funds_table')
                    tablesData.splice(index, 1)
                }
            });


            $('#gift').change(function () {
                if (this.checked === true) {
                    $('#giftcards_table').parents(".donation_table").slideDown(300);
                    tablesData.push('giftcards_table')
                } else {
                    $('#giftcards_table').parents(".donation_table").slideUp(300);
                    var index = tablesData.indexOf('giftcards_table')
                    tablesData.splice(index, 1)
                }
            });


            $('#clothing').change(function () {
                if (this.checked === true) {
                    $('#clothing_table').parents(".donation_table").slideDown(300);
                    tablesData.push('clothing_table')
                } else {
                    $('#clothing_table').parents(".donation_table").slideUp(300);
                    var index = tablesData.indexOf('clothing_table')
                    tablesData.splice(index, 1) 
                }
            });


            $('#food').change(function () {
                if (this.checked === true) {
                    $('#foods_table').parents(".donation_table").slideDown(300);
                    tablesData.push('foods_table')
                } else {
                    $('#foods_table').parents(".donation_table").slideUp(300);
                    var index = tablesData.indexOf('foods_table')
                    tablesData.splice(index, 1) 
                }
            });


            $('#misc').change(function () {
                if (this.checked === true) {
                    $('#misc_table').parents(".donation_table").slideDown(300);
                    tablesData.push('misc_table')
                } else {
                    $('#misc_table').parents(".donation_table").slideUp(300);
                    var index = tablesData.indexOf('misc_table')
                    tablesData.splice(index, 1)
                }
            });

            $('#all').change(function () {
                if (this.checked === true) {
                    $('table').parents(".donation_table").slideDown(300);
                    $("input[type=checkbox].donation_select").prop('checked', true);
                    tablesData.push('funds_table')
                    tablesData.push('giftcards_table')
                    tablesData.push('clothing_table')
                    tablesData.push('foods_table')
                    tablesData.push('misc_table')
                } else {
                    {#$('h3').slideUp(300);#}
                    $('table').parents(".donation_table").slideUp(300);
                    $("input[type=checkbox].donation_select").prop('checked', false);
                    tablesData = []
                }
            });


            {#Handles export feature#}
            $('#export').click(function (e) {

                const exact = {}

                if ($("#id_first_name").val() !== "")
                    exact.first_name = $("#id_first_name").val()
                if ($("#id_last_name").val() !== "")
                    exact.last_name = $("#id_last_name").val()
                if ($("#id_donation_date_from").val() !== "")
                    exact.date_from = $("#id_donation_date_from").val()
                if ($("#id_donation_date_to").val() !== "")
                    exact.date_to = $("#id_donation_date_to").val()
                
                const exportParams = {exact: exact, tables_selected: tablesData}

                $.ajax({
                    url: 'download_my_file/',
                    datatype: 'json',
                    data: {"data": JSON.stringify(exportParams)},
                    type: 'GET',
                    xhrFields: {
                        responseType: 'blob'
                    },
                    success: function (data) {
                        var a = document.createElement('a');
                        var url = window.URL.createObjectURL(data);
                        a.href = url;
                        a.download = 'test.xls';
                        document.body.append(a);
                        a.click();
                        a.remove();
                        window.URL.revokeObjectURL(url);
                    },
                    error: function (er) {
                        console.log(er)
                    }

                });
            });

        })
    </script>


{% endblock %}
{% extends 'users/base.html' %}

{% load static %}

{% block content %}

    <!-- Includes styling for tables -->
    <link rel="stylesheet" type="text/css" href="{% static 'raw_data.css' %}">


    <div class="alert alert-success fade in text-center hide" role="alert">
        <strong class="msg"> </strong>
    </div>
    <h1 class="text-center">Edit Donations</h1>
    <hr>

    <div id="content" class="content edit_donation">
        <div id="content" class="content raw_data">

            <div class="donation_table p-3 m-5">
                <h2 class="text-center">Funds</h2>
                <hr>
                <table id="funds_table" data-height="460" class="table table-striped table-bordered data-table"
                       data-search="true" data-pagination="true" data-advanced-search="true" data-show-toggle="true"
                       data-show-columns="true" data-show-export="false" data-ajax="getTableData"
                       data-show-refresh="true" data-escape="true"
                       data-page-list="[5,10, 25, 50]" data-page-size="10" data-side-pagination="server"
                       data-search-on-enter-key="true">
                    <thead class="fund_header">
                    <tr>
                        <th data-sortable="true" data-field="item_id" data-filter-control="input" data-visible="false">
                            id
                        </th>
                        <th data-sortable="true" data-field="first_name" data-filter-control="input">First Name</th>
                        <th data-sortable="true" data-field="last_name" data-filter-control="input">Last Name</th>
                        <th data-sortable="true" data-field="date_received" data-formatter="dateFormat"
                            data-filter-control="input">Date Received
                        </th>
                        <th data-sortable="true" data-field="sub_type" data-filter-control="select">Type</th>
                        <th data-sortable="true" data-field="amount" data-filter-control="input">Amount</th>
                        <th data-sortable="true" data-field="quantity" data-filter-control="input">Quantity</th>
                        <th data-sortable="true" data-field="comments" data-filter-control="input"
                            class="text-capitalize">Comments
                        </th>
                        <th data-field="action" data-formatter="actionFormatter">Action</th>
                    </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <div class="donation_table p-3 m-5">
                <h2 class="text-center">Gift Card</h2>
                <hr>
                <table id="giftcards_table" data-height="460" class="table table-striped table-bordered data-table"
                       data-search="true" data-pagination="true" data-advanced-search="true" data-show-toggle="true"
                       data-show-columns="true" data-show-export="false" data-ajax="getTableData"
                       data-show-refresh="true" data-escape="true"
                       data-page-list="[5,10, 25, 50]" data-page-size="10" data-side-pagination="server"
                       data-search-on-enter-key="true">
                    <thead class="giftcard_header">
                    <tr>
                        <th data-sortable="true" data-field="item_id" data-filter-control="input" data-visible="false">
                            id
                        </th>
                        <th data-sortable="true" data-field="first_name" data-filter-control="input">First Name</th>
                        <th data-sortable="true" data-field="last_name" data-filter-control="input">Last Name</th>
                        <th data-sortable="true" data-field="date_received" data-formatter="dateFormat"
                            data-filter-control="input">Date Received
                        </th>
                        <th data-sortable="true" data-field="sub_type" data-filter-control="select">Type</th>
                        <th data-sortable="true" data-field="amount" data-filter-control="input">Amount</th>
                        <th data-sortable="true" data-field="quantity" data-filter-control="input">Quantity</th>
                        <th data-sortable="true" data-field="comments" data-filter-control="input"
                            class="text-capitalize">Comments
                        </th>
                        <th data-field="action" data-formatter="actionFormatter">Action</th>
                    </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <div class="donation_table p-3 m-5">
                <h2 class="text-center">Food</h2>
                <hr>
                <table id="foods_table" data-height="460" class="table table-striped table-bordered data-table"
                       data-search="true" data-pagination="true" data-advanced-search="true" data-show-toggle="true"
                       data-show-columns="true" data-show-export="false" data-ajax="getTableData"
                       data-show-refresh="true" data-escape="true"
                       data-page-list="[5,10, 25, 50]" data-page-size="10" data-side-pagination="server"
                       data-search-on-enter-key="true">
                    <thead class="food_header">
                    <tr>
                        <th data-sortable="true" data-field="item_id" data-filter-control="input" data-visible="false">
                            ID
                        </th>
                        <th data-sortable="true" data-field="first_name" data-filter-control="input"
                            class="text-capitalize">First Name
                        </th>
                        <th data-sortable="true" data-field="last_name" data-filter-control="input"
                            class="text-capitalize">Last Name
                        </th>
                        <th data-sortable="true" data-field="date_received" data-formatter="dateFormat"
                            data-filter-control="input">Date Received
                        </th>
                        <th data-sortable="true" data-field="sub_type" data-filter-control="select"
                            class="text-capitalize">Type
                        </th>
                        <th data-sortable="true" data-field="quantity" data-filter-control="input">Quantity</th>
                        <th data-sortable="true" data-field="comments" data-filter-control="input"
                            class="text-capitalize">Comments
                        </th>
                        <th data-field="action" data-formatter="actionFormatter">Action</th>
                    </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <div class="donation_table p-3 m-5">
                <h2 class="text-center">Clothing</h2>
                <hr>
                <table id="clothing_table" data-height="460" class="table table-striped table-bordered data-table"
                       data-search="true" data-pagination="true" data-advanced-search="true" data-show-toggle="true"
                       data-show-columns="true" data-show-export="false" data-ajax="getTableData"
                       data-show-refresh="true" data-escape="true"
                       data-page-list="[5,10, 25, 50]" data-page-size="10" data-side-pagination="server"
                       data-search-on-enter-key="true">
                    <thead class="clothing_header">
                    <tr>
                        <th data-sortable="true" data-field="item_id" data-filter-control="input" data-visible="false">
                            ID
                        </th>
                        <th data-sortable="true" data-field="first_name" data-filter-control="input"
                            class="text-capitalize">First Name
                        </th>
                        <th data-sortable="true" data-field="last_name" data-filter-control="input"
                            class="text-capitalize">Last Name
                        </th>
                        <th data-sortable="true" data-field="date_received" data-formatter="dateFormat"
                            data-filter-control="input">Date Received
                        </th>
                        <th data-sortable="true" data-field="sub_type" data-filter-control="select"
                            class="text-capitalize">Type
                        </th>
                        <th data-sortable="true" data-field="quantity" data-filter-control="input">Quantity</th>
                        <th data-sortable="true" data-field="comments" data-filter-control="input"
                            class="text-capitalize">Comments
                        </th>
                        <th data-field="action" data-formatter="actionFormatter">Action</th>

                    </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <div class="donation_table p-3 m-5">

                <h2 class="text-center">Miscellaneous</h2>
                <hr>
                <table id="misc_table" data-height="460" class="table table-striped table-bordered data-table"
                       data-search="true" data-pagination="true" data-advanced-search="true" data-show-toggle="true"
                       data-show-columns="true" data-show-export="false" data-ajax="getTableData"
                       data-show-refresh="true" data-escape="true"
                       data-page-list="[5,10, 25, 50]" data-page-size="10" data-side-pagination="server"
                       data-search-on-enter-key="true">
                    <thead class="misc_header">
                    <tr>
                        <th data-sortable="true" data-field="item_id" data-filter-control="input" data-visible="false">
                            ID
                        </th>
                        <th data-sortable="true" data-field="first_name" data-filter-control="input"
                            class="text-capitalize">First Name
                        </th>
                        <th data-sortable="true" data-field="last_name" data-filter-control="input"
                            class="text-capitalize">Last Name
                        </th>
                        <th data-sortable="true" data-field="date_received" data-formatter="dateFormat"
                            data-filter-control="input">Date Received
                        </th>
                        <th data-sortable="true" data-field="sub_type" data-filter-control="select"
                            class="text-capitalize">Type
                        </th>
                        <th data-sortable="true" data-field="quantity" data-filter-control="input">Quantity</th>
                        <th data-sortable="true" data-field="comments" data-filter-control="input"
                            class="text-capitalize">Comments
                        </th>
                        <th data-field="action" data-formatter="actionFormatter">Action</th>

                    </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
    <div style="display: none" id="item_form">
        {{ item_form.type }}
    </div>
    <div style="display: none" id="funds_types">
        {{ funds_form_types.type }}
    </div>
    <div style="display: none" id="businesses">
        {{ item_form.sub_type_business }}
    </div>
    <div style="display: none" id="clothing_types">
        {{ item_form.sub_type_clothing }}
    </div>
    <div style="display: none" id="food_types">
        {{ item_form.sub_type_name }}
    </div>
    <div style="display: none" id="misc_types">
        {{ item_form.sub_type_name }}
    </div>
    <script>
        let FUNDS_TYPES = $("#funds_types").children().last();
        let BUSINESSES = $("#businesses").children().last();
        let CLOTHING_TYPES = $("#clothing_types").children().last();
        let FOOD_TYPES = $("#food_types").children().last();
        let MISC_TYPES = $("#misc_types").children().last();

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    // Does this cookie string begin with the name we want?
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        let tables_data = {};

        function getTableData(params) {
            let table_type = $(this)[0].$el.attr("id")
            $.ajax({
                url: 'get_table/',
                datatype: 'json',
                data: $.param(params.data) + "&table_type=" + table_type,
                type: 'GET',
                success: function (data) {
                    console.log(table_type)
                    console.log(data)
                    tables_data[table_type] = data["rows"]
                    params.success({
                        "rows": data["rows"],
                        "total": data["total"]
                    })
                },
                error: function (er) {
                    params.error(er);
                    console.log("Error while pulling data with the following parameters:  " + er)
                }

            });
        }


        $(window).on('load', function () {
            $('.data-table').each(function () {
                let table_type = $(this).attr("id")
                $(this).bootstrapTable({
                    onPostBody(data) {
                        bindEditButton(table_type)
                        bindRemoveButton(table_type)
                    }

                });
            })
        })


        let editing = false;

        function actionFormatter(i, row) {
            let html = []
            $.each(row, function (k, v) {
                if (k === 'first_name') {
                    html.push('<button type="button" class="editbtn btn btn-primary edit" >Edit</button>')
                    html.push('<button type="button" class="deletebtn-funds btn btn-primary btn-danger ms-2" >Delete</button>')
                }
            })
            return html.join("")
        }


        let oldValuesBeforeEdit = []


        function bindEditButton(table_type) {
            if (editing) return
            editing = true;
            $("#" + table_type + " .editbtn").click(function () {
                let $this = $(this);
                let $row = $this.parents("tr")
                let tds = $this.closest('tr').find('td')
                tds.last().children().last().html("Cancel")
                tds.splice(-1, 1)

                if ($this.html() === 'Edit') {
                    $this.html('Save');
                    {# First 3 columns are uneditable #}
                    $(tds.slice(0, 2)).css({"cursor": "not-allowed"})
                    tds = tds.slice(2)


                    oldValuesBeforeEdit = [];
                    {# We're handling td's instead of the whole tr since the buttons are already binded to the actions#}
                    tds.map(function (i, e) {
                        oldValuesBeforeEdit.push($(e).prop('outerHTML'))
                    })

                    $(tds[0]).html($("<input type=\"date\" style='padding: 0' name=\"date_received\" class=\"form-control\" required id=\"id_date_received\">").val(moment($(tds[0]).html(), 'MM/DD/YYYY').format('yyyy-MM-DD')))
                    if (table_type === "funds_table"){
                        $(tds[1]).html(FUNDS_TYPES.val($(tds[1]).html()))
                    } else if (table_type === "giftcards_table"){
                        $(tds[1]).html(BUSINESSES.val($(tds[1]).html()))
                    } else if (table_type === "foods_table"){
                        $(tds[1]).html(FOOD_TYPES.val($(tds[1]).html()))
                    } else if (table_type === "clothing_table"){
                        $(tds[1]).html(CLOTHING_TYPES.val($(tds[1]).html()))
                    } else if (table_type === "misc_table"){
                        $(tds[1]).html(MISC_TYPES.val($(tds[1]).html()))
                    }

                    $(tds[2]).html($("<input type=\"number\" min=\"0\" max=\"1000\" style=\"padding: 0;\" class=\"form-control\">").val($(tds[2]).html()))
                    $(tds[3]).html($("<input type=\"number\" min=\"0\" max=\"1000\" style=\"padding: 0;\" class=\"form-control\">").val($(tds[3]).html()))
                    $(tds[4]).html($("<input type=\"text\" style=\"padding: 0;\" class=\"form-control\">").val($(tds[4]).html()))

                    {#tds.prop('contenteditable', true)#}
                    tds.closest("tr").css({
                        'border-top': '3px #6d8786 dashed',
                        'border-bottom': '3px #6d8786 dashed',
                        'color': '#000'
                    });
                    $this.parentsUntil("table").find('tr').not($($this.closest('tr'))).animate({opacity: 0.4}, 300);
                    {#$this.parentsUntil("table").find('button').not($($this.closest('button'))).attr("disabled", true);#}
                } else {

                    let table_type = $(this).parents(".table").attr('id')
                    let row_index = $row.attr("data-index")
                    edit_donation(row_index, table_type, $row, $this)
                }
            });
            editing = false;
        }


        function exitEditRowMode($this) {
            let tds = $this.closest('tr').find('td')
            let buttons = tds.last().children()
            $(buttons[0]).html('Edit');
            $(buttons[1]).html('Delete');

            tds.splice(-1, 1)
            $(tds.slice(0, 2)).css({"cursor": "auto"})

            {#tds.prop('contenteditable', false)#}
            tds.closest("tr").css({
                'border': "none",
                'color': '#000'
            });
            $this.parentsUntil("table").find("tr").animate({opacity: 1}, 300);
            {#$this.parentsUntil("table").find('button').attr("disabled", false);#}

            {# Set the cell to the date was selected and remove the input element #}
            $(tds[2]).html(dateFormat($(tds[2]).children().last().val(), 'MM/DD/YYYY'))
            // tds = tds.splice(3);
            console.log(tds)
            $(tds).each(function (i) {
                $(this).html($(this).children().last().val())
            })
        }

        const tables_keys = {
            "funds_table": ["first_name", "last_name", "date_received", "sub_type", "amount", "quantity", "comments"],
            "giftcards_table": ["first_name", "last_name", "date_received", "sub_type", "amount", "quantity", "comments"],
            "foods_table": ["first_name", "last_name", "date_received", "sub_type", "quantity", "comments"],
            "clothing_table": ["first_name", "last_name", "date_received", "sub_type", "quantity", "comments"],
            "misc_table": ["first_name", "last_name", "date_received", "sub_type", "quantity", "comments"],
        };

        function edit_donation(row_index, table_type, $row, $this) {
            let old_data = tables_data[table_type][row_index]
            let keys = tables_keys[table_type]
            {# Remove the actions column #}
            let columns = $row.find("td").slice(0, -1)
            console.log(columns)
            console.log(old_data)

            let new_data = old_data
            columns.each(function (i) {
                console.log($(this).children().last().val())
                let cellChild = $(this).children()
                if (cellChild.length > 0)
                    new_data[keys[i]] = $(this).children().last().val()
                else
                    new_data[keys[i]] = $(this).html()
            })

            $("body").css("cursor", "wait")

            $.ajax({
                url: 'update_item/',
                datatype: 'json',
                data: {"table_type": table_type, "update_data": JSON.stringify(new_data)},
                type: 'POST',
                headers: {
                    "X-CSRFToken": getCookie("csrftoken")
                },
                success: function (resp) {
                    console.log(resp)
                    console.log("SAVED")
                    tables_data[table_type][row_index] = new_data;
                    $(".alert").addClass("alert-success").hide().removeClass("alert-danger hide").slideDown(300)
                    $(".alert .msg").html("Record was updated successfully.")
                    exitEditRowMode($this);
                    $("#" + table_type).bootstrapTable("refresh");
                    $("body").css("cursor", "auto")
                    setTimeout(
                        function () {
                            $(".alert").slideUp(300)
                        }, 3000);

                },
                error: function (er) {
                    console.log(JSON.stringify(er))
                    console.log("Error while saving:  " + er.responseJSON.error)
                    $(".alert").addClass("alert-danger").hide().removeClass("alert-success hide").slideDown(300)
                    $(".alert .msg").html("Error while updating record. " + er.responseJSON.error)
                    $("body").css("cursor", "auto")
                    setTimeout(
                        function () {
                            $(".alert").slideUp(300)
                        }, 6000);

                }
            });


        }

        function bindRemoveButton(table_type) {
            $("#" + table_type + " .deletebtn-funds").click(function () {
                let tds = $(this).closest('tr').find('td')
                tds = tds.slice(2)
                {#tds.splice(-1, 1)#}

                if ($(this).html() === "Cancel") {
                    $("body").css("cursor", "auto")
                    tds.map(function (i, e) {
                        $(tds[i]).html($(oldValuesBeforeEdit[i]).html())
                    })
                    oldValuesBeforeEdit = []
                    exitEditRowMode($(this))
                    return;
                }


                if (!confirm("You sure you want to delete this donation? This is irreversible...")) return
                let row_id = $(this).parentsUntil("tr").parent().find("td").first().text()
                let row = $(this).parentsUntil("tr").parent()
                let table_type = $(this).parents(".table").attr('id')
                console.log(row_id)
                console.log(table_type)
                if (row_id == null) return;
                {#return;#}
                $.ajax
                ({
                    url: 'delete_item/',
                    data: {"item_id": row_id, "table_type": table_type},
                    type: 'post',
                    headers: {
                        "X-CSRFToken": getCookie("csrftoken")
                    },
                    mode: "same-origin",
                    success: function (result) {
                        if ("error" in result) {
                            alert(result["error"])
                            $("#funds_table").bootstrapTable('refresh')
                            return
                        }
                        row.remove()
                        alert("Deleted!")
                    },
                    error: function (textStatus, errorThrown) {
                        alert("Error deleting: " + textStatus);
                        {#TODO remove logs, only for debugging#}
                        console.log("Error deleting: " + textStatus)
                        console.log(errorThrown)
                    }
                });
            })
        }

        function dateFormat(value, row, index) {
            return moment(value).format('MM/DD/YYYY');
        }


        {#    Export #}
        let $table = $('#funds_table')

        $(function () {
            $('#toolbar').find('select').change(function () {
                $table.bootstrapTable('destroy').bootstrapTable({
                    exportDataType: $(this).val(),
                    exportTypes: ['json', 'xml', 'csv', 'txt', 'sql', 'excel', 'pdf'],
                    columns: [
                        {
                            //Rename columns
                            field: 'id',
                            title: 'ID'
                        }
                    ]
                })
            }).trigger('change')
        })
    </script>
{% endblock %}
